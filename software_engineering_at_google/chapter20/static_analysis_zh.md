## 第二十章

# 静态分析

*Written by Caitlin Sadowski  
Edited by Lisa Carey*

静态分析是指程序对源代码进行分析以发现潜在的问题，例如错误，反面模式和其他无需执行程序即可诊断的问题。“静态”部分特指分析源代码，而不是分析正在运行的程序（称为“动态”分析）。静态分析可以在程序作为生产代码检入之前尽早发现程序中的错误。例如，静态分析可以识别到溢出的常量表达式，永不运行的测试，日志中的无效格式字符串等在执行时会崩溃的语句。<sup id="a1">[[1]](#f1)</sup> 但是，静态分析的有用之处不仅在于发现 bug。通过Google的静态分析，我们整理了最佳做法，帮助使代码与最新的 API 保持版本一致，并防止或减少了技术负担。这些分析的示例包括验证是否遵循命名约定，标记不赞成使用的 API 的使用，或者指出使代码更易于阅读的更简单但等效的表达式。静态分析也是 API 弃用过程中不可或缺的工具，可以在将代码库迁移到新 API 的过程中防止回退（请参阅 [第二十二章](../chapter22/large_scale_changes_en.md)）。我们还发现有证据表明静态分析检查可以引导开发人员并切实地阻止反面模式进入代码库。<sup id="a2">[[2]](#f2)</sup>

在本章中，我们将研究什么是有效的静态分析，在 Google 学到的一些使静态分析更有效的经验，以及如何在静态分析工具和流程中实施。<sup id="a3">[[3]](#f3)</sup>

## 有效静态分析的特点
在开发新的分析技术和特定分析上，尽管已经有数十年的静态分析研究，但是提高静态分析工具的可扩展性和可用性的方法仍是相对前沿的发展方向。

### 可扩展性
由于现代软件已经变得越来越庞大，因此分析工具必须显式地解决扩展问题，以便及时生成结果，而不会拖慢软件开发的进度。Google 的静态分析工具必须扩展到 Google 数十亿行代码库的规模。为此，分析工具是可共享的和增量更新的。我们不会分析整个大型项目，而是将分析重点放在受代码更改影响的文件上，并且通常仅显示针对已编辑文件或行的分析结果。扩展也有好处：由于我们的代码库很大，因此在查找错误方面有很多 bug 需要查找。除了确保分析工具可以在大型代码库上运行之外，我们还必须扩大可用分析的数量和种类。面向整个公司征求分析意见。静态分析可伸缩性的另一个组件是确保流程可扩展。为此，Google静态分析基础架构通过直接向相关工程师显示分析结果来避免瓶颈分析。
### 可用性
在考虑分析可用性时，重要的是要考虑静态分析工具用户的成本和收益权衡。 此“成本”可以是开发人员时间，也可以是代码质量。 修复静态分析警告可能会引入错误。 对于不经常修改的代码，为什么要“修复”在生产环境中运行良好的代码？ 例如，通过添加对先前无效代码的调用来修复无效代码警告，可能会导致未经测试甚至可能是错误的代码突然运行。收益不明，成本可能很高。因此，我们通常将重点放在新引入的警告上。如果工作代码特别重要（例如安全问题，重大错误修复等），则通常仅应突出显示（并修复）本来可以正常工作的代码中存在的问题。 关注新引入的警告（或修改的行上的警告）还意味着查看警告的开发人员对其有相关的调用。

另外，开发人员的时间很宝贵！ 将花费在对分析报告进行分类或解决突出问题上的时间与特定分析所提供的收益进行权衡。 如果分析作者可以节省时间（例如，通过提供可以自动应用于相关代码的修复程序），那么折衷的成本就会降低。 可以自动修复的所有内容都应自动修复。 我们还尝试向开发人员显示有关实际上对代码质量有负面影响的问题的报告，以使他们不会在无关紧要的结果上浪费时间。

为了进一步降低查看静态分析结果的成本，我们专注于平稳的开发人员工作流集成。 使一个工作流程中的所有内容均质化的另一个优势是，专门的工具团队可以随工作流程和代码一起更新工具，从而使分析工具可以与源代码一起发展。

我们相信，在使静态分析具有可扩展性和可用性时，我们做出的这些选择和权衡取舍源于我们对三项核心原则的关注，这些原则将在下一节中进行阐述。

## 进行静态分析的关键经验
我们从 Google 上学到了三项关键经验，这些经验使静态分析工具能够很好地发挥作用。 我们将在下文中对其进行介绍。

### 关注开发者的感受
我们提到了一些方法试图节省开发人员时间并减少与上述静态分析工具进行交互的成本。 我们还将跟踪分析工具的性能。 如果你不对此采取一些措施，就无法解决问题。 我们只会部署误报率较低的分析工具。 我们还积极地实时征询开发人员的反馈，并根据其反馈采取行动。 在静态分析工具用户和开发人员之间培育这种反馈循环，会形成一个良性循环，从而建立了用户信任并改善了我们的工具。 用户信任对于静态分析工具的成功至关重要。

对于静态分析，“假阴性”是指一段代码中包含分析工具旨在发现的问题，但该工具却忽略了该问题。 当工具错误地将代码标记为有问题时，就会出现“误报”。 传统上关于静态分析工具的研究集中在减少误报上。 在实践中，低误报率对于开发人员实际使用工具通常很关键——谁想在数百个错误报告中寻找一些真实的报告呢？<sup id="a4">[[4]](#f4)</sup>

此外，用户感知是假阳性率的关键。如果静态分析工具产生的警告在技术上是正确的，但被用户误认为是误报（例如，由于混淆的消息），那么用户的反应将与这些警告实际上是误报一样。同样，在技术上正确但在总体方案中不重要的警告也会引起同样的反应。我们将用户感知的假阳性率称为“有效假阳性”率。如果开发人员在看到问题后未采取任何积极行动，则该问题为“有效误报”。这意味着，如果分析错误地报告了问题，但是开发人员仍然乐于进行修复以提高代码的可读性或可维护性，那不是有效误报。例如，我们有一个 Java 分析，当开发人员在一个哈希表上调用了 `contains` 方法（等效于 `containsValue`）时给出标记——即使开发人员打算正确地检查该值，调用 `containsValue` 会更具可读性。同样，如果分析报告存在实际故障，但是开发人员不了解该故障，因此未采取任何措施，这是有效的误报。

### 使静态分析成为核心开发人员工作流程的一部分
在 Google，我们通过与代码审查工具的集成将静态分析集成到核心工作流程中。 基本上，所有代码在被提交给 Google 之前都必须经过审核； 由于开发人员在发送代码进行审查时已经处于变更思维中，因此可以进行静态分析工具建议的改进而不会造成太多干扰。 代码审查集成还有其他好处， 开发人员通常在发送代码以供审阅后进行上下文切换，并被审阅者拦下——即使有几分钟的时间，分析仍然有时间运行。 审阅者也面临同事的压力，要求他们解决静态分析警告。 此外，静态分析可以通过自动突出显示常见问题来节省审阅者的时间； 静态分析工具可帮助代码审查过程（和审阅者）扩展。 代码审查是分析结果的最佳方案。<sup id="a5">[[5]](#f5)</sup>

### 为用户贡献赋能
Google 有很多领域专家，他们的知识可以改善所生成的代码。 静态分析是利用专业知识并大规模应用专业知识的机会，让领域专家编写新的分析工具或对工具中的模块单独检查。

例如，了解特定类型配置文件部分的专家可以编写分析器来检查那些文件的属性。 除了领域专家之外，分析还由发现错误的开发人员提供，他们希望防止同一类型的错误再次出现在代码库的其他任何地方。 我们专注于构建易于插入的静态分析生态系统，而不是集成少量现有工具。 我们致力于开发简单的 API，供整个 Google 的工程师（不仅是分析人员或语言专家）用来创建分析的 API。 例如，Refaster<sup id="a6">[[6] ](#f6)</sup>允许通过指定前代码段和后代码段来编写分析器，以说明该分析器期望进行哪些转换。

## Tricorder：Google 的静态分析平台
Tricorder，我们的静态分析平台，是Google静态分析的核心部分<sup id="a7">[[7]](#f7)</sup>。Tricorder 诞生自将静态分析与 Google 开发人员工作流程集成的几次失败尝试；<sup id="a8">[[8]](#f8)</sup> Tricorder 和以前的尝试之间的主要区别是我们不懈地致力于让 Tricorder 仅向其用户提供有价值的结果。Tricorder 与 Google Critique 的主要代码审查工具集成在一起。 Tricorder 警告在 Critique 的查看器中显示为灰色注释框，如 [图 20-1](https://i.loli.net/2021/04/13/xfsrGWhi5HlumwB.jpg) 所示。
![figure20-1.jpg](https://i.loli.net/2021/04/13/xfsrGWhi5HlumwB.jpg)
*Figure 20-1. Critique 的差异视图，以灰色显示来自 Tricorder 的静态分析警告*

为了扩展，Tricorder 使用了微服务架构。 Tricorder 系统将分析请求以及有关代码更改的元数据发送到分析服务器。 这些服务器可以使用该元数据通过基于 FUSE 的文件系统读取更改中的源代码文件的版本，并且可以访问缓存的构建输入和输出。 然后，分析服务器开始运行每个单独的分析器，并将输出写入存储层； 每个类别的最新结果将显示在“批注”中。 由于分析有时需要几分钟才能运行，因此分析服务器还会发布状态更新，以使变更作者和审阅者知道分析器正在运行，并在分析器完成时发布完成的状态。 Tricorder 每天分析超过 50,000 个代码审查更改，并且通常每秒运行几次分析。

整个 Google 的开发人员都编写 Tricorder 分析或对现有分析进行单独的“检查”。 新的 Tricorder 检查有四个条件：

易读性
- 让输出信息对任何工程师都能容易读懂。

易修复
- 该修复可能比编译器检查需要更多的时间、思想或精力，并且结果应包括有关如何确实解决此问题的指南

低误报
- 开发人员应该感觉到检查至少 90％ 的检查中指出了实际问题。

潜移默化地提高代码质量
- 这些问题可能不会影响正确性，但是开发人员应认真对待它们，并修复它们。 

Tricorder 分析器报告 30 多种语言的结果，并支持多种分析类型。 Tricorder 包括 100 多个分析器，其中大多数来自 Tricorder 团队以外的人员。 这些分析器中的七个本身就是插件系统，具有数百种其他检查功能，这些检查程序又由 Google 的开发人员提供。 总体有效假阳性率略低于 5％。

### 综合集成工具
Tricorder 集成了许多不同类型的静态分析工具。

容易出错和 clang-tidy 扩展了编译器，以分别识别 Java 和 C ++ 的 AST 反面模式。 这些反面模式可能代表真正的错误。 例如，考虑以下代码片段对 long 类型的字段 f 进行哈希处理：

- `result = 31 * result + (int) (f ^ (f >>> 32));`

现在考虑 f 的类型为 int 的情况。 该代码仍将编译，但是右移 32 位是空操作，因此 f 与自身进行 XOR 运算，并且不再影响所产生的值。 我们在 Google 的代码库中修复了 31 个此类错误，同时在“容易出错”中启用了作为编译器错误的检查功能。 还有更多这样的例子。 AST反模式还可以提高代码的可读性，例如，删除智能指针上对 `.get()` 的多余调用。

其他分析器展示了语料库中不同文件之间的关系。 Deleted Artifact Analyzer 会警告是否删除了代码库中其他非代码位置所引用的源文件（例如，签入文档中的内容）。 “如果 A 那么 B”模式允许开发人员指定必须同时更改两个不同文件的各个部分（如果没有，则发出警告）。 Chrome 浏览器的 Finch 分析器在用于 Chrome 浏览器A / B实验的配置文件上运行，突出显示了常见问题，包括未获得批准才能启动实验或与影响相同总体的其他当前正在运行的实验进行串扰。 Finch 分析器对其他服务进行远程过程调用（RPC），以提供此信息。

除了源代码本身之外，某些分析器还可以在由该源代码产生的其他编译结果上运行；例如， 许多项目启用了二进制大小检查器，当更改对二进制大小有重大影响时会发出警告。

几乎所有分析器都是过程内分析器，这意味着分析结果基于过程（功能）中的代码。 组合式或增量式过程间分析技术在技术上是可行的，但需要额外的基础设施投资（例如，在分析器运行时分析和存储方法摘要）。

